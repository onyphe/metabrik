#!/usr/bin/perl
#
# $Id$
#
use strict;
use warnings;

BEGIN {
   use File::HomeDir;

   my $lib = File::HomeDir->my_home."/perl5/lib/perl5";
   $lib =~ s/\\/\//g; # Converts Windows paths

   eval("use lib \"$lib\";");
   if ($@) {
      chomp($@);
      die("[F] metabrik: unable to use Metabrik libs [$@]\n");
   }
}

use Getopt::Long;
use Metabrik::Brik::Core::Context;

my $script;
my $rc;
my $history;
my $verbose = 2;
my $debug = 0;
GetOptions(
   "script=s" => \$script,
   "rc=s" => \$rc,
   "history=s" => \$history,
   "verbose=i" => \$verbose,
   "debug=i" => \$debug,
) or return usage();

my $context = Metabrik::Brik::Core::Context->new;

$context->brik_init
   or die("[F] metabrik: context init: failed\n");

$context->set('core::log', 'level', $verbose);

$context->set('core::log', 'debug', $debug);
$context->set('core::context', 'debug', $debug);
$context->set('core::shell', 'debug', $debug);
$context->set('core::global', 'debug', $debug);

if (defined($script)) {
   $context->use('shell::script')
      or die("[F] metabrik: use: shell::script: failed\n");

   $context->set('shell::script', 'debug', $debug);
   $context->set('shell::script', 'file', $script);

   my $lines = $context->run('shell::script', 'load')
      or die("[F] metabrik: run: shell::script: load: failed\n");

   $context->run('shell::script', 'exec', $lines)
      or die("[F] metabrik: run: shell::script: exec: failed\n");
}
else {
   $context->use('shell::rc')
      or die("[F] metabrik: use: shell::rc: failed\n");

   $context->set('shell::rc', 'debug', $debug);

   $context->run('core::shell', 'splash')
      or die("[F] metabrik: run: core::shell: splash: failed\n");

   $context->run('core::shell', 'cmdloop');
}

exit(0);
